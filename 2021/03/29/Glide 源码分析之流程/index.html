<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Glide 源码分析之流程"><meta name="keywords" content="源码分析,Glide"><meta name="author" content="zhangws"><meta name="copyright" content="zhangws"><title>Glide 源码分析之流程 | 新小梦</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="新小梦" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text"> 摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#with%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text"> with函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#glide%E5%8D%95%E4%BE%8B%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text"> Glide单例的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestmanager%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">2.2.</span> <span class="toc-text"> RequestManager的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#supportfragmentget"><span class="toc-number">2.3.</span> <span class="toc-text"> supportFragmentGet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getapplicationmanager"><span class="toc-number">2.4.</span> <span class="toc-text"> getApplicationManager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEload"><span class="toc-number">3.</span> <span class="toc-text"> 配置：load</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83into"><span class="toc-number">4.</span> <span class="toc-text"> 核心：into</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#singlerequest%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">4.1.</span> <span class="toc-text"> SingleRequest的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestmanagertrack"><span class="toc-number">4.2.</span> <span class="toc-text"> requestManager.track</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#engineload"><span class="toc-number">4.3.</span> <span class="toc-text"> engine.load</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text"> 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/xxm-sz/dio@main/img/20210205152041.png"></div><div class="author-info__name text-center">zhangws</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://juejin.cn/user/888061125471917">关注我</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://github.com/xxm-sz">Github</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://juejin.cn/user/888061125471917/posts">掘金</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://xxm-sz.github.io/">博客</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">新小梦</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">目录</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Glide 源码分析之流程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-29</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>阅读时长: 22 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="摘要"><a class="markdownIt-Anchor" href="#摘要"></a> 摘要</h2>
<p>Glide流程三步曲<code>with</code>、<code>load</code>、<code>into</code>三个函数，完成一次Glide请求。<code>with</code>的主要工作是首次创建Glide单例，并装配Glide各种配置参数和创建相关实例，这些都会在<code>into</code>函数中被使用到,第二个要点就是与Fragment的生命周期绑定，让Glide请求能感应到生命周期的变化，从而可以进行暂停，恢复，发起请求的一下操作。<code>load</code>函数则是构建本次<code>Glide</code>请求的相关信息，例如<code>RequestBuilder</code>、<code>RequestOptions</code>等。<code>into</code>函数则是Glide的核心，包括缓存，解码，采样转化，资源获取等等。</p>
<p>Glide源码分析基于<code>Glide 4.12.0</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.github.bumptech.glide:glide:4.12.0'</span></span><br><span class="line">annotationProcessor <span class="string">'com.github.bumptech.glide:compiler:4.12.0'</span></span><br></pre></td></tr></tbody></table></figure>
<p>由于源码分析阶段会有很多分支，很多的类型，所以在一些点会基于下面例子分析。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val url=<span class="string">"http//:www.xxm-sz.githu.io/test.png"</span></span><br><span class="line">Glide.with(<span class="keyword">this</span>).load(url).into(imageView)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="with函数"><a class="markdownIt-Anchor" href="#with函数"></a> <code>with</code>函数</h2>
<h3 id="glide单例的创建"><a class="markdownIt-Anchor" href="#glide单例的创建"></a> Glide单例的创建</h3>
<p><code>Glide.with</code>有很多重载函数。这里以<code>Activity</code>为例分析。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> FragmentActivity activity)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>Glide.with</code>的所有重载函数中的<code>getRetriever</code>都是调用<code>getRetriever</code>来生成<code>Glide</code>单例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">getRetriever</span><span class="params">(<span class="meta">@Nullable</span> Context context)</span> </span>{</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>Glide.get(context)</code>通过<strong>双重检查</strong>实现单例模式，生成Glide实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (glide == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="comment">//步骤1</span></span><br><span class="line">    GeneratedAppGlideModule annotationGeneratedModule =</span><br><span class="line">        getAnnotationGeneratedGlideModules(context.getApplicationContext());</span><br><span class="line">    <span class="keyword">synchronized</span> (Glide.class) {</span><br><span class="line">      <span class="keyword">if</span> (glide == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">//步骤2</span></span><br><span class="line">        checkAndInitializeGlide(context, annotationGeneratedModule);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> glide;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在<code>Application</code> 模块中，可创建一个添加有 <code>@GlideModule</code> 注解，继承自 <code>AppGlideModule</code> 的类，这样就可以通过流式API使用Glide。<code>GeneratedAppGlideModule</code>也就是对应该注解类的。</p>
<p><strong>步骤1：</strong> <code>getAnnotationGeneratedGlideModules</code>函数主要通过反射获取我们<code>AppGlideModule</code>实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> GeneratedAppGlideModule <span class="title">getAnnotationGeneratedGlideModules</span><span class="params">(Context context)</span> </span>{</span><br><span class="line">  GeneratedAppGlideModule result = <span class="keyword">null</span>;</span><br><span class="line">...</span><br><span class="line">   Class&lt;GeneratedAppGlideModule&gt; clazz =</span><br><span class="line">        (Class&lt;GeneratedAppGlideModule&gt;)</span><br><span class="line">            Class.forName(<span class="string">"com.bumptech.glide.GeneratedAppGlideModuleImpl"</span>);</span><br><span class="line">   result =</span><br><span class="line">        clazz.getDeclaredConstructor(Context.class).newInstance(context.getApplicationContext());</span><br><span class="line"> ...</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>步骤2：</strong> <code>checkAndInitializeGlide</code>函数最终会调用到<code>initializeGlide</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> GlideBuilder builder,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule)</span> </span>{</span><br><span class="line">  Context applicationContext = context.getApplicationContext();</span><br><span class="line">  List&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; manifestModules = Collections.emptyList();</span><br><span class="line">  <span class="comment">//通过AndroidManifest文件解析Module</span></span><br><span class="line">  <span class="keyword">if</span> (annotationGeneratedModule == <span class="keyword">null</span> || annotationGeneratedModule.isManifestParsingEnabled()) {</span><br><span class="line">    manifestModules = <span class="keyword">new</span> ManifestParser(applicationContext).parse();</span><br><span class="line">  }</span><br><span class="line">	<span class="comment">//将AndroidManifest文件解析到的所有Module中剔除掉通过注解获取到的Module</span></span><br><span class="line">  <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; !annotationGeneratedModule.getExcludedModuleClasses().isEmpty()) {</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; excludedModuleClasses = annotationGeneratedModule.getExcludedModuleClasses();</span><br><span class="line">    Iterator&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; iterator = manifestModules.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">      com.bumptech.glide.<span class="keyword">module</span>.GlideModule current = iterator.next();</span><br><span class="line">      <span class="keyword">if</span> (!excludedModuleClasses.contains(current.getClass())) {</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      }</span><br><span class="line">      iterator.remove();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  RequestManagerRetriever.RequestManagerFactory factory =</span><br><span class="line">      annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">          ? annotationGeneratedModule.getRequestManagerFactory()</span><br><span class="line">          : <span class="keyword">null</span>;</span><br><span class="line">  builder.setRequestManagerFactory(factory);</span><br><span class="line">  <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) {</span><br><span class="line">    <span class="keyword">module</span>.applyOptions(applicationContext, builder);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) {</span><br><span class="line">    annotationGeneratedModule.applyOptions(applicationContext, builder);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//通过GildeBuilder构建出Glide</span></span><br><span class="line">  Glide glide = builder.build(applicationContext);</span><br><span class="line">  <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">module</span>.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">    } <span class="keyword">catch</span> (AbstractMethodError e) {</span><br><span class="line">    ...</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) {</span><br><span class="line">    annotationGeneratedModule.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">  }</span><br><span class="line">  applicationContext.registerComponentCallbacks(glide);</span><br><span class="line">  Glide.glide = glide;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其实在没有定义<code>GlideModule</code>情况下，这段代码只有一个核心点，通过<code>GlideBuilder</code>构建Glide,为Glide创建默认的属性，例如缓存，引擎等等。创建的对象在后续<code>into</code>函数中被大量使用到。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Glide <span class="title">build</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (sourceExecutor == <span class="keyword">null</span>) {</span><br><span class="line">    sourceExecutor = GlideExecutor.newSourceExecutor();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (diskCacheExecutor == <span class="keyword">null</span>) {</span><br><span class="line">    diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (animationExecutor == <span class="keyword">null</span>) {</span><br><span class="line">    animationExecutor = GlideExecutor.newAnimationExecutor();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (memorySizeCalculator == <span class="keyword">null</span>) {</span><br><span class="line">    memorySizeCalculator = <span class="keyword">new</span> MemorySizeCalculator.Builder(context).build();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (connectivityMonitorFactory == <span class="keyword">null</span>) {</span><br><span class="line">    connectivityMonitorFactory = <span class="keyword">new</span> DefaultConnectivityMonitorFactory();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bitmapPool == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="keyword">int</span> size = memorySizeCalculator.getBitmapPoolSize();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) {</span><br><span class="line">      bitmapPool = <span class="keyword">new</span> LruBitmapPool(size);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      bitmapPool = <span class="keyword">new</span> BitmapPoolAdapter();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (arrayPool == <span class="keyword">null</span>) {</span><br><span class="line">    arrayPool = <span class="keyword">new</span> LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (memoryCache == <span class="keyword">null</span>) {</span><br><span class="line">    memoryCache = <span class="keyword">new</span> LruResourceCache(memorySizeCalculator.getMemoryCacheSize());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (diskCacheFactory == <span class="keyword">null</span>) {</span><br><span class="line">    diskCacheFactory = <span class="keyword">new</span> InternalCacheDiskCacheFactory(context);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (engine == <span class="keyword">null</span>) {</span><br><span class="line">    engine =</span><br><span class="line">        <span class="keyword">new</span> Engine(</span><br><span class="line">            memoryCache,</span><br><span class="line">            diskCacheFactory,</span><br><span class="line">            diskCacheExecutor,</span><br><span class="line">            sourceExecutor,</span><br><span class="line">            GlideExecutor.newUnlimitedSourceExecutor(),</span><br><span class="line">            animationExecutor,</span><br><span class="line">            isActiveResourceRetentionAllowed);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (defaultRequestListeners == <span class="keyword">null</span>) {</span><br><span class="line">    defaultRequestListeners = Collections.emptyList();</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    defaultRequestListeners = Collections.unmodifiableList(defaultRequestListeners);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  GlideExperiments experiments = glideExperimentsBuilder.build();</span><br><span class="line">  RequestManagerRetriever requestManagerRetriever =</span><br><span class="line">      <span class="keyword">new</span> RequestManagerRetriever(requestManagerFactory, experiments);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Glide(</span><br><span class="line">      context,</span><br><span class="line">      engine,</span><br><span class="line">      memoryCache,</span><br><span class="line">      bitmapPool,</span><br><span class="line">      arrayPool,</span><br><span class="line">      requestManagerRetriever,</span><br><span class="line">      connectivityMonitorFactory,</span><br><span class="line">      logLevel,</span><br><span class="line">      defaultRequestOptionsFactory,</span><br><span class="line">      defaultTransitionOptions,</span><br><span class="line">      defaultRequestListeners,</span><br><span class="line">      experiments);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="requestmanager的创建"><a class="markdownIt-Anchor" href="#requestmanager的创建"></a> <code>RequestManager</code>的创建</h3>
<p><code>RequestManager</code>的创建涉及到与<code>Application</code>或<code>Fragment</code>生命周期的绑定，<code>RequestManager</code>可以用来开始和停止、管理本次Glide请求。</p>
<p>再回到<code>getRetriever(activity).get(activity)</code>的<code>get</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> FragmentActivity activity)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (Util.isOnBackgroundThread()) {</span><br><span class="line">    <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    assertNotDestroyed(activity);</span><br><span class="line">    frameWaiter.registerSelf(activity);</span><br><span class="line">    FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line">    <span class="keyword">return</span> supportFragmentGet(activity, fm, <span class="comment">/*parentHint=*/</span> <span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过<code>Util.isOnBackgroundThread()</code>判断是否后台线程，如果不是则通过<code>supportFragmentGet</code>创建<code>RequestManager</code>。否则通过<code>get(activity)</code>的重载函数<code>get(Context)</code>获取<code>RequestManager</code>。查看<code>get()</code>的其他重载函数，如果在后台线程或者参数为<code>ApplicationContext</code>上下文，都通过<code>getApplicationManager(context)</code>来生成<code>RequestManager</code>，而其他情况则是<code>supportFragmentGet</code>函数。</p>
<h3 id="supportfragmentget"><a class="markdownIt-Anchor" href="#supportfragmentget"></a> <code>supportFragmentGet</code></h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">supportFragmentGet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> Fragment parentHint,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isParentVisible)</span> </span>{</span><br><span class="line">  <span class="comment">//步骤1:获取SupportRequestManagerFragment</span></span><br><span class="line">  SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);</span><br><span class="line">  <span class="comment">//步骤2：获取RequestManager</span></span><br><span class="line">  RequestManager requestManager = current.getRequestManager();</span><br><span class="line">  <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) {</span><br><span class="line">    Glide glide = Glide.get(context);</span><br><span class="line">    requestManager =</span><br><span class="line">        factory.build(</span><br><span class="line">            glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">    <span class="keyword">if</span> (isParentVisible) {</span><br><span class="line">      requestManager.onStart();</span><br><span class="line">    }</span><br><span class="line">    current.setRequestManager(requestManager);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> requestManager;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>步骤1</strong>：通过<code>getSupportRequestManagerFragment</code>函数创建<code>SupportRequestManagerFragment</code>对象。<code>SupportRequestManagerFragment</code>是<code>Fragment</code>的子类，该<code>Fragment</code>对象是没有视图，作为发起<code>Glide</code>请求的<code>Activity</code>或<code>Fragment</code>的子<code>Fragment</code>，将持有<code>RequestManager</code>实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SupportRequestManagerFragment <span class="title">getSupportRequestManagerFragment</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> <span class="keyword">final</span> FragmentManager fm, <span class="meta">@Nullable</span> Fragment parentHint)</span> </span>{</span><br><span class="line">  <span class="comment">//tag查找</span></span><br><span class="line">  SupportRequestManagerFragment current =</span><br><span class="line">      (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">  <span class="keyword">if</span> (current == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="comment">//HashMap查找</span></span><br><span class="line">    current = pendingSupportRequestManagerFragments.get(fm);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) {</span><br><span class="line">      <span class="comment">//新建</span></span><br><span class="line">      current = <span class="keyword">new</span> SupportRequestManagerFragment();</span><br><span class="line">      current.setParentFragmentHint(parentHint);</span><br><span class="line">      pendingSupportRequestManagerFragments.put(fm, current);</span><br><span class="line">      fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">      handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> current;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>先通过<code>FRAGMENT_TAG</code>标签在<code>FragmentMananger</code>中查找是否有已添加的<code>Fragment</code>实例。没有的话，在<code>endingSupportRequestManagerFragments</code>查找,<code>endingSupportRequestManagerFragments</code>是<code>HashMap</code>类型的,以<code>FragmentMananger</code>为<code>key</code>，<code>SupportRequestManagerFragment</code>为<code>Value</code>。没有的话，则新建实例，并添加<code>pendingSupportRequestManagerFragments</code>中，并通过<code>FragmentMananger</code>提交。这个创建逻辑也保证了在一个<code>Activity</code>中所发起的所有Glide请求都只有一个空白<code>Fragment</code>。</p>
<p>在创建<code>SupportRequestManagerFragment</code>时候，会创建一个新的<code>ActivityFragmentLifecycle</code>，用于跟踪和监听<code>Fragment</code>的生命周期事件。</p>
<p>**步骤2：**在步骤1获取到了<code>Fragment</code>后，获取其持有的<code>RequestManager</code>,如果<code>Fragment</code>是新建获得，那肯定是没有，只能通过新建<code>RequestManager</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">factory.build(glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br></pre></td></tr></tbody></table></figure>
<p>这里的<code>factory</code>是<code>RequestManagerFactory</code>，在构建Glide单例的时候会创建，默认情况下是<code>DEFAULT_FACTORY</code>。在创建<code>RequestManager</code>时不仅监听<code>Fragment</code>生命周期的变化，还会监听网络连接变化。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestManagerFactory DEFAULT_FACTORY =</span><br><span class="line">  <span class="keyword">new</span> RequestManagerFactory() {</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestManager <span class="title">build</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> Glide glide,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> Lifecycle lifecycle,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> Context context)</span> </span>{</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RequestManager(glide, lifecycle, requestManagerTreeNode, context);</span><br><span class="line">    }</span><br><span class="line">  };</span><br></pre></td></tr></tbody></table></figure>
<p>所以，当<code>Fragment</code>生命周期发生变化或者网络发生变化时，<code>RequestManager</code>根据不同场景去管理本次<code>Glide</code>请求。</p>
<p>在<code>View</code>场景下的<code>Glide.with()</code>稍微麻烦点，需要根据<code>View.getContext()</code>得到<code>Context</code>的类型,去查找不同的<code>get()</code>函数重载。而<code>Fragment</code>场景下，与<code>Actvity</code>发起的Glide请求大同小异。</p>
<h3 id="getapplicationmanager"><a class="markdownIt-Anchor" href="#getapplicationmanager"></a> <code>getApplicationManager</code></h3>
<p>在后台线程或<code>ApplicationContext</code>场景下，通过<code>getApplicationManager(context)</code>创建<code>RequestManager</code>。通过下面代码可以看到，<code>RequestManager</code>直接与<code>Application</code>的生命周期绑定。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">getApplicationManager</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">      <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) {</span><br><span class="line">        Glide glide = Glide.get(context.getApplicationContext());</span><br><span class="line">        applicationManager =</span><br><span class="line">            factory.build(</span><br><span class="line">                glide,</span><br><span class="line">                <span class="keyword">new</span> ApplicationLifecycle(),</span><br><span class="line">                <span class="keyword">new</span> EmptyRequestManagerTreeNode(),</span><br><span class="line">                context.getApplicationContext());</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> applicationManager;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>而<code>ApplicationLifecycle</code>基本什么都没做，因为Glide请求与Application绑定，意味随着<code>Applilcation</code>的消亡而消亡。</p>
<p>到这里，<code>Glide.with()</code>的分析就完毕了，主要创建<code>Glide</code>单例，和为<code>Glide</code>请求创建<code>RequestManager</code>。在后台线程或者<code>ApplicationContext</code>情况下创建的<code>RequestManager</code>是与<code>Application</code>的生命周期绑定的，而其他情况下，通过创建一个无视图的<code>Fragment</code>的，并将<code>RequestManager</code>与其生命周期绑定。</p>
<h2 id="配置load"><a class="markdownIt-Anchor" href="#配置load"></a> 配置：load</h2>
<p><code>load</code>函数也有很多重载函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;XXX&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> XXX xxx)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> asDrawable().load(xxx);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>所以看一下<code>asDrawable()</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> Class&lt;ResourceType&gt; resourceClass)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可见，<code>asDrawable</code>函数主要是创建了<code>RequestBuilder</code>对象，<code>RequestBuilder</code>是<code>BaseRequestOptions</code>的子类，用于保存Glide通用资源类型的配置参数。<code>BaseRequestOptions</code>的另外一个子类<code>RequestOptions</code>,通常用来配置一次独立的Glide请求配置参数。注意这里的<code>as</code>的参数<code>Drawable.class</code>，表明的是本次请求的目标资源是<code>Drawable.class</code>,即后续分析会看到<code>transcodeClass</code>就是该<code>Drawable.class</code>。仅下载情况是<code>File.class</code>，Gif图情况下是<code>GifDrawable.class</code>。</p>
<p>继续看<code>RequestBuilder</code>的<code>load</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> String string)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (isAutoCloneEnabled()) {</span><br><span class="line">    <span class="keyword">return</span> clone().loadGeneric(model);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">this</span>.model = model;</span><br><span class="line">  isModelSet = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">return</span> selfOrThrowIfLocked();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>主要是将我们设置的资源:<code>Glide.with(context).load(xxx)</code>中的<code>xxx</code>设置给<code>RequestBuilder</code>的<code>model</code>属性，并将<code>isModelSet</code>设置<code>true</code>。后续分析中<code>modelClass</code>就是这里<code>xxx</code>的类型。</p>
<p>假如这里<code>load(drawable)</code>或者<code>load(bitmap)</code>，会有多一个步骤：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> Drawable drawable)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> loadGeneric(drawable).apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>也就是多了<code>apply(options)</code>,跟我们自定义Glide请求配置是一致的。这里也会将<code>RequestOptions</code>缓存起来。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">apply</span><span class="params">(<span class="meta">@NonNull</span> BaseRequestOptions&lt;?&gt; o)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (isAutoCloneEnabled) {</span><br><span class="line">    <span class="keyword">return</span> clone().apply(o);</span><br><span class="line">  }</span><br><span class="line">  BaseRequestOptions&lt;?&gt; other = o;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, SIZE_MULTIPLIER)) {</span><br><span class="line">    sizeMultiplier = other.sizeMultiplier;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, USE_UNLIMITED_SOURCE_GENERATORS_POOL)) {</span><br><span class="line">    useUnlimitedSourceGeneratorsPool = other.useUnlimitedSourceGeneratorsPool;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, USE_ANIMATION_POOL)) {</span><br><span class="line">    useAnimationPool = other.useAnimationPool;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, DISK_CACHE_STRATEGY)) {</span><br><span class="line">    diskCacheStrategy = other.diskCacheStrategy;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PRIORITY)) {</span><br><span class="line">    priority = other.priority;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ERROR_PLACEHOLDER)) {</span><br><span class="line">    errorPlaceholder = other.errorPlaceholder;</span><br><span class="line">    errorId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~ERROR_ID;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ERROR_ID)) {</span><br><span class="line">    errorId = other.errorId;</span><br><span class="line">    errorPlaceholder = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~ERROR_PLACEHOLDER;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PLACEHOLDER)) {</span><br><span class="line">    placeholderDrawable = other.placeholderDrawable;</span><br><span class="line">    placeholderId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~PLACEHOLDER_ID;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, PLACEHOLDER_ID)) {</span><br><span class="line">    placeholderId = other.placeholderId;</span><br><span class="line">    placeholderDrawable = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~PLACEHOLDER;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, IS_CACHEABLE)) {</span><br><span class="line">    isCacheable = other.isCacheable;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, OVERRIDE)) {</span><br><span class="line">    overrideWidth = other.overrideWidth;</span><br><span class="line">    overrideHeight = other.overrideHeight;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, SIGNATURE)) {</span><br><span class="line">    signature = other.signature;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, RESOURCE_CLASS)) {</span><br><span class="line">    resourceClass = other.resourceClass;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, FALLBACK)) {</span><br><span class="line">    fallbackDrawable = other.fallbackDrawable;</span><br><span class="line">    fallbackId = <span class="number">0</span>;</span><br><span class="line">    fields &amp;= ~FALLBACK_ID;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, FALLBACK_ID)) {</span><br><span class="line">    fallbackId = other.fallbackId;</span><br><span class="line">    fallbackDrawable = <span class="keyword">null</span>;</span><br><span class="line">    fields &amp;= ~FALLBACK;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, THEME)) {</span><br><span class="line">    theme = other.theme;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION_ALLOWED)) {</span><br><span class="line">    isTransformationAllowed = other.isTransformationAllowed;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION_REQUIRED)) {</span><br><span class="line">    isTransformationRequired = other.isTransformationRequired;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, TRANSFORMATION)) {</span><br><span class="line">    transformations.putAll(other.transformations);</span><br><span class="line">    isScaleOnlyOrNoTransform = other.isScaleOnlyOrNoTransform;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (isSet(other.fields, ONLY_RETRIEVE_FROM_CACHE)) {</span><br><span class="line">    onlyRetrieveFromCache = other.onlyRetrieveFromCache;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Applying options with dontTransform() is expected to clear our transformations.</span></span><br><span class="line">  <span class="keyword">if</span> (!isTransformationAllowed) {</span><br><span class="line">    transformations.clear();</span><br><span class="line">    fields &amp;= ~TRANSFORMATION;</span><br><span class="line">    isTransformationRequired = <span class="keyword">false</span>;</span><br><span class="line">    fields &amp;= ~TRANSFORMATION_REQUIRED;</span><br><span class="line">    isScaleOnlyOrNoTransform = <span class="keyword">true</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  fields |= other.fields;</span><br><span class="line">  options.putAll(other.options);<span class="comment">//缓存RequestOptions</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selfOrThrowIfLocked();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>也就是说<code>load</code>函数的主要工作是配置Glide请求的一些参数。</p>
<h2 id="核心into"><a class="markdownIt-Anchor" href="#核心into"></a> 核心：into</h2>
<p><code>into</code>函数也有很多重载函数，但我们最常用的就是<code>into(ImageView)</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(<span class="meta">@NonNull</span> ImageView view)</span> </span>{</span><br><span class="line">  ...</span><br><span class="line">  BaseRequestOptions&lt;?&gt; requestOptions = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (!requestOptions.isTransformationSet()</span><br><span class="line">      &amp;&amp; requestOptions.isTransformationAllowed()</span><br><span class="line">      &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) {</span><br><span class="line">    <span class="keyword">switch</span> (view.getScaleType()) {</span><br><span class="line">      <span class="keyword">case</span> CENTER_CROP:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CENTER_INSIDE:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FIT_CENTER:</span><br><span class="line">      <span class="keyword">case</span> FIT_START:</span><br><span class="line">      <span class="keyword">case</span> FIT_END:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FIT_XY:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CENTER:</span><br><span class="line">      <span class="keyword">case</span> MATRIX:</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// Do nothing.</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> into(</span><br><span class="line">      glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">      <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">      requestOptions,</span><br><span class="line">      Executors.mainThreadExecutor());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>从这里看到Glide只处理<code>View ScaleType</code>的<code>CENTER_CROP</code>、<code>CENTER_INSIDE、</code> <code>FIT_XY</code>，而<code>FIT_CENTER</code>、<code>FIT_START</code>、<code>FIT_END</code>都统一通过<code>optionalFitCenter</code>处理，而<code>CENTER</code>和<code>MATRIX</code>则直接忽略。然后调用<code>into</code>另外一个重载函数。先通过<code>glideContext.buildImageViewTarget</code>将<code>ImageView</code>封装成<code>ViewTarget</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> &lt;X&gt; <span class="function">ViewTarget&lt;ImageView, X&gt; <span class="title">buildImageViewTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="meta">@NonNull</span> ImageView imageView, <span class="meta">@NonNull</span> Class&lt;X&gt; transcodeClass)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTargetFactory</span> </span>{</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@SuppressWarnings("unchecked")</span></span><br><span class="line">  <span class="keyword">public</span> &lt;Z&gt; <span class="function">ViewTarget&lt;ImageView, Z&gt; <span class="title">buildTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="meta">@NonNull</span> ImageView view, <span class="meta">@NonNull</span> Class&lt;Z&gt; clazz)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (Bitmap.class.equals(clazz)) {</span><br><span class="line">      <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (Drawable.class.isAssignableFrom(clazz)) {</span><br><span class="line">      <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">          <span class="string">"Unhandled class: "</span> + clazz + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过<code>ImageViewTargetFactory</code>工厂的<code>buildTarget</code>函数可以发现<code>ViewTarget</code>有两种类型:<code>BitmapImageViewTraget</code>和<code>DrawableImageViewTarget</code>。两者都是<code>ImageViewTarget</code>的子类，前者用于展示<code>Bitmap</code>，后者用于展示<code>Drawable</code>。另外一个子类<code>ThumbnailImageViewTarget</code>，用于在固定尺寸的<code>ImageView</code>展示多张图片，避免额外调用<code>requestLayout</code>，常用场景就是列表的缩略图设置。</p>
<p><code>into</code>函数的第三个参数<code>Executors.mainThreadExecutor()</code>,在主线程执行的线程池，也就是调用线程池的<code>execute</code>函数时，将<code>runable</code>对象通过<code>handler post</code>到主线程的队列,这样就在主线程执行了该任务。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">mainThreadExecutor</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> MAIN_THREAD_EXECUTOR;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">mainThreadExecutor</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> MAIN_THREAD_EXECUTOR;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor MAIN_THREAD_EXECUTOR =</span><br><span class="line">    <span class="keyword">new</span> Executor() {</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="meta">@NonNull</span> Runnable command)</span> </span>{</span><br><span class="line">        Util.postOnUiThread(command);</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">postOnUiThread</span><span class="params">(Runnable runnable)</span> </span>{</span><br><span class="line">  getUiThreadHandler().post(runnable);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Handler <span class="title">getUiThreadHandler</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (mainThreadHandler == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="keyword">synchronized</span> (Util.class) {</span><br><span class="line">      <span class="keyword">if</span> (mainThreadHandler == <span class="keyword">null</span>) {</span><br><span class="line">        mainThreadHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> mainThreadHandler;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>继续看看<code>into</code>的重载函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@NonNull</span> Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line">  Preconditions.checkNotNull(target);</span><br><span class="line">  <span class="keyword">if</span> (!isModelSet) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must call #load() before calling #into()"</span>);</span><br><span class="line">  }</span><br><span class="line"><span class="comment">//步骤1</span></span><br><span class="line">  Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br><span class="line"><span class="comment">//查看view的tag是否设置了Request</span></span><br><span class="line">  Request previous = target.getRequest();</span><br><span class="line">  <span class="keyword">if</span> (request.isEquivalentTo(previous)</span><br><span class="line">      &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) {</span><br><span class="line">    <span class="keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) {</span><br><span class="line">      previous.begin();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  requestManager.clear(target);</span><br><span class="line">  target.setRequest(request);</span><br><span class="line">  <span class="comment">//步骤2</span></span><br><span class="line">  requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>步骤1：</strong> 通过<code>buildRequest</code>创建了<code>Request</code>对象，<code>Request</code>代表了一次为目标<code>Target</code>加载图片资源<code>resource</code>的<code>Glide</code>请求。</p>
<h3 id="singlerequest的创建"><a class="markdownIt-Anchor" href="#singlerequest的创建"></a> SingleRequest的创建</h3>
<p>通过<code>buildRequest</code>函数会创建一个<code>Request</code>对象，该对象是<code>Request</code>的子类实例，可能<code>ThumbnailRequestCoordinator</code>或<code>ErrorRequestCoordinator</code>也有可能是<code>SingleRequest</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> buildRequestRecursive(</span><br><span class="line">      <span class="comment">/*requestLock=*/</span> <span class="keyword">new</span> Object(),</span><br><span class="line">      target,</span><br><span class="line">      targetListener,</span><br><span class="line">      <span class="comment">/*parentCoordinator=*/</span> <span class="keyword">null</span>,</span><br><span class="line">      transitionOptions,</span><br><span class="line">      requestOptions.getPriority(),</span><br><span class="line">      requestOptions.getOverrideWidth(),</span><br><span class="line">      requestOptions.getOverrideHeight(),</span><br><span class="line">      requestOptions,</span><br><span class="line">      callbackExecutor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>调用了<code>buildRequestRecursive</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Object requestLock,</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span></span><br><span class="line">  ErrorRequestCoordinator errorRequestCoordinator = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (errorBuilder != <span class="keyword">null</span>) {</span><br><span class="line">    errorRequestCoordinator = <span class="keyword">new</span> ErrorRequestCoordinator(requestLock, parentCoordinator);</span><br><span class="line">    parentCoordinator = errorRequestCoordinator;</span><br><span class="line">  }</span><br><span class="line"><span class="comment">//步骤A</span></span><br><span class="line">  Request mainRequest =</span><br><span class="line">      buildThumbnailRequestRecursive(</span><br><span class="line">          requestLock,</span><br><span class="line">          targ  et,</span><br><span class="line">          targetListener,</span><br><span class="line">          parentCoordinator,</span><br><span class="line">          transitionOptions,</span><br><span class="line">          priority,</span><br><span class="line">          overrideWidth,</span><br><span class="line">          overrideHeight,</span><br><span class="line">          requestOptions,</span><br><span class="line">          callbackExecutor);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) {</span><br><span class="line">    <span class="keyword">return</span> mainRequest;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> errorOverrideWidth = errorBuilder.getOverrideWidth();</span><br><span class="line">  <span class="keyword">int</span> errorOverrideHeight = errorBuilder.getOverrideHeight();</span><br><span class="line">  <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight) &amp;&amp; !errorBuilder.isValidOverride()) {</span><br><span class="line">    errorOverrideWidth = requestOptions.getOverrideWidth();</span><br><span class="line">    errorOverrideHeight = requestOptions.getOverrideHeight();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  Request errorRequest =</span><br><span class="line">      errorBuilder.buildRequestRecursive(</span><br><span class="line">          requestLock,</span><br><span class="line">          target,</span><br><span class="line">          targetListener,</span><br><span class="line">          errorRequestCoordinator,</span><br><span class="line">          errorBuilder.transitionOptions,</span><br><span class="line">          errorBuilder.getPriority(),</span><br><span class="line">          errorOverrideWidth,</span><br><span class="line">          errorOverrideHeight,</span><br><span class="line">          errorBuilder,</span><br><span class="line">          callbackExecutor);</span><br><span class="line">  errorRequestCoordinator.setRequests(mainRequest, errorRequest);</span><br><span class="line">  <span class="keyword">return</span> errorRequestCoordinator;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>步骤A:</strong> <code>buildThumbnailRequestRecursive</code>创建了<code>Request</code>,这里返回的<code>Request</code>有两种可能，一种是设置了加载缩略图和主图的，返回的<code>ThumbnailRequestCoordinator</code>,会协调好缩略图<code>SingleRequest</code>和主图<code>SingleRequest</code>的同时加载。另外一种是<code>SingleRequest</code>,单单加载主图，两者都是<code>Request</code>的子类。</p>
<p>如果有设置在发生错误时的请求也会在这里配置该请求，通过后面的分析，也就是每个<code>RequestBuilder</code>（不仅是主图，也可以是缩略图，错误提示图等）都会创建一个<code>SingleRequest</code>。</p>
<p>接着看<code>buildThumbnailRequestRecursive</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildThumbnailRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Object requestLock,</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="meta">@Nullable</span> RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line">  <span class="comment">//由于没有设置缩略图，直接走else分支</span></span><br><span class="line">  <span class="keyword">if</span> (thumbnailBuilder != <span class="keyword">null</span>) {</span><br><span class="line">    <span class="comment">// Recursive case: contains a potentially recursive thumbnail request builder.</span></span><br><span class="line">    <span class="keyword">if</span> (isThumbnailBuilt) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">          <span class="string">"You cannot use a request as both the main request and a "</span></span><br><span class="line">              + <span class="string">"thumbnail, consider using clone() on the request(s) passed to thumbnail()"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; thumbTransitionOptions =</span><br><span class="line">        thumbnailBuilder.transitionOptions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (thumbnailBuilder.isDefaultTransitionOptionsSet) {</span><br><span class="line">      thumbTransitionOptions = transitionOptions;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Priority thumbPriority =</span><br><span class="line">        thumbnailBuilder.isPrioritySet()</span><br><span class="line">            ? thumbnailBuilder.getPriority()</span><br><span class="line">            : getThumbnailPriority(priority);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> thumbOverrideWidth = thumbnailBuilder.getOverrideWidth();</span><br><span class="line">    <span class="keyword">int</span> thumbOverrideHeight = thumbnailBuilder.getOverrideHeight();</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)</span><br><span class="line">        &amp;&amp; !thumbnailBuilder.isValidOverride()) {</span><br><span class="line">      thumbOverrideWidth = requestOptions.getOverrideWidth();</span><br><span class="line">      thumbOverrideHeight = requestOptions.getOverrideHeight();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ThumbnailRequestCoordinator coordinator =</span><br><span class="line">        <span class="keyword">new</span> ThumbnailRequestCoordinator(requestLock, parentCoordinator);</span><br><span class="line">    Request fullRequest =</span><br><span class="line">        obtainRequest(</span><br><span class="line">            requestLock,</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            requestOptions,</span><br><span class="line">            coordinator,</span><br><span class="line">            transitionOptions,</span><br><span class="line">            priority,</span><br><span class="line">            overrideWidth,</span><br><span class="line">            overrideHeight,</span><br><span class="line">            callbackExecutor);</span><br><span class="line">    isThumbnailBuilt = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//调用了thumbnailBuilder.buildRequestRecursive，此时是没有设置缩略图的，直接走else分支，返回了SingleRequest</span></span><br><span class="line">    Request thumbRequest =</span><br><span class="line">        thumbnailBuilder.buildRequestRecursive(</span><br><span class="line">            requestLock,</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            coordinator,</span><br><span class="line">            thumbTransitionOptions,</span><br><span class="line">            thumbPriority,</span><br><span class="line">            thumbOverrideWidth,</span><br><span class="line">            thumbOverrideHeight,</span><br><span class="line">            thumbnailBuilder,</span><br><span class="line">            callbackExecutor);</span><br><span class="line">    isThumbnailBuilt = <span class="keyword">false</span>;</span><br><span class="line">    coordinator.setRequests(fullRequest, thumbRequest);</span><br><span class="line">    <span class="keyword">return</span> coordinator;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (thumbSizeMultiplier != <span class="keyword">null</span>) {</span><br><span class="line">    <span class="comment">//缩略因子</span></span><br><span class="line">    ThumbnailRequestCoordinator coordinator =</span><br><span class="line">        <span class="keyword">new</span> ThumbnailRequestCoordinator(requestLock, parentCoordinator);</span><br><span class="line">    Request fullRequest =</span><br><span class="line">        obtainRequest(</span><br><span class="line">            requestLock,</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            requestOptions,</span><br><span class="line">            coordinator,</span><br><span class="line">            transitionOptions,</span><br><span class="line">            priority,</span><br><span class="line">            overrideWidth,</span><br><span class="line">            overrideHeight,</span><br><span class="line">            callbackExecutor);</span><br><span class="line">    BaseRequestOptions&lt;?&gt; thumbnailOptions =</span><br><span class="line">        requestOptions.clone().sizeMultiplier(thumbSizeMultiplier);</span><br><span class="line"></span><br><span class="line">    Request thumbnailRequest =</span><br><span class="line">        obtainRequest(</span><br><span class="line">            requestLock,</span><br><span class="line">            target,</span><br><span class="line">            targetListener,</span><br><span class="line">            thumbnailOptions,</span><br><span class="line">            coordinator,</span><br><span class="line">            transitionOptions,</span><br><span class="line">            getThumbnailPriority(priority),</span><br><span class="line">            overrideWidth,</span><br><span class="line">            overrideHeight,</span><br><span class="line">            callbackExecutor);</span><br><span class="line"></span><br><span class="line">    coordinator.setRequests(fullRequest, thumbnailRequest);</span><br><span class="line">    <span class="keyword">return</span> coordinator;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// Base case: no thumbnail.</span></span><br><span class="line">    <span class="keyword">return</span> obtainRequest(</span><br><span class="line">        requestLock,</span><br><span class="line">        target,</span><br><span class="line">        targetListener,</span><br><span class="line">        requestOptions,</span><br><span class="line">        parentCoordinator,</span><br><span class="line">        transitionOptions,</span><br><span class="line">        priority,</span><br><span class="line">        overrideWidth,</span><br><span class="line">        overrideHeight,</span><br><span class="line">        callbackExecutor);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>由于没有设置缩略图，直接走<code>else</code>分支，通过<code>obtainRequest</code>获得<code>Request</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">obtainRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Object requestLock,</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line">  <span class="keyword">return</span> SingleRequest.obtain(</span><br><span class="line">      context,</span><br><span class="line">      glideContext,</span><br><span class="line">      requestLock,</span><br><span class="line">      model,</span><br><span class="line">      transcodeClass,</span><br><span class="line">      requestOptions,</span><br><span class="line">      overrideWidth,</span><br><span class="line">      overrideHeight,</span><br><span class="line">      priority,</span><br><span class="line">      target,</span><br><span class="line">      targetListener,</span><br><span class="line">      requestListeners,</span><br><span class="line">      requestCoordinator,</span><br><span class="line">      glideContext.getEngine(),</span><br><span class="line">      transitionOptions.getTransitionFactory(),</span><br><span class="line">      callbackExecutor);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过<code>SingleRequest.obtain</code>函数返回了<code>Request</code>对象。<code>obtain</code>函数直接创建了<code>Request</code>的子类<code>SingleRequest</code>对象。</p>
<p>这里<code>buildRequest</code>函数小结一下:</p>
<ul>
<li>如果设置了缩略图，返回<code>ThumbnailRequestCoordinator</code>对象，包含了主图和缩图两个独立的<code>SingleRequest</code>。</li>
<li>如果设置了错误占位图，返回的是<code>ErrorRequestCoordinator</code>,包含了上一步返回的<code>Request</code>对象和占位图的<code>SingleRequest</code>对象，</li>
<li>如果上两步都没有设置，返回主图的<code>SingleRequest</code>。</li>
</ul>
<p>继续分析<code>into</code>函数的<strong>步骤2：</strong></p>
<h3 id="requestmanagertrack"><a class="markdownIt-Anchor" href="#requestmanagertrack"></a> <code>requestManager.track</code></h3>
<p><code>track</code>函数分别用了<code>TragetTrack</code>和<code>RequestTrack</code>跟踪本次请求的<code>traget</code>和<code>request</code>对象。<code>RequestTrack</code>主要用于跟踪，取消和重启正在运行中的，已完成或者失败的请求。<code>TragetTrack</code>则持有当前活跃的<code>RequestManager</code>以及转发绑定的生命周期事件。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(<span class="meta">@NonNull</span> Target&lt;?&gt; target, <span class="meta">@NonNull</span> Request request)</span> </span>{</span><br><span class="line">  <span class="comment">//将Traget存放到set中</span></span><br><span class="line">  targetTracker.track(target);</span><br><span class="line"> 	<span class="comment">//开始请求 </span></span><br><span class="line">  requestTracker.runRequest(request);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>看看<code>RequestTrack</code>的<code>runRequest</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(<span class="meta">@NonNull</span> Request request)</span> </span>{</span><br><span class="line">  requests.add(request);</span><br><span class="line">  <span class="keyword">if</span> (!isPaused) {<span class="comment">//首次创建肯定是false</span></span><br><span class="line">    request.begin();</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    request.clear();</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {</span><br><span class="line">      Log.v(TAG, <span class="string">"Paused, delaying request"</span>);</span><br><span class="line">    }</span><br><span class="line">    pendingRequests.add(request);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>看看<code>request.begin()</code>函数。我们这里直接定位到<code>SingleRequest</code>的<code>begin</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="keyword">synchronized</span> (requestLock) {</span><br><span class="line"> ......</span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) {</span><br><span class="line">      onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      target.getSize(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">        &amp;&amp; canNotifyStatusChanged()) {</span><br><span class="line">      target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>定位到<code>target.getSize(this)</code>获取<code>Target</code>尺寸大小，这里的<code>this</code>是<code>SizeReadyCallback</code>。也就是在获取到目标尺寸之后，通过<code>SizeReadyCallback</code>对象回调。这里的<code>Target</code>对象直接定位到<code>ViewTarget</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSize</span><span class="params">(<span class="meta">@NonNull</span> SizeReadyCallback cb)</span> </span>{</span><br><span class="line">  sizeDeterminer.getSize(cb);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过<code>getSize</code>函数的注释，就知道了Glide如何去获取尺寸的。</p>
<ul>
<li>直接获取View的宽高，如果都大于零或者等于原始尺寸，说明已经能获取到了。</li>
<li>直接获取View的LayotuParams，如果都大于零或者等于原始尺寸，说明已经能获取到了。</li>
<li>添加<code>addOnPreDrawListener</code>监听。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getSize</span><span class="params">(<span class="meta">@NonNull</span> SizeReadyCallback cb)</span> </span>{</span><br><span class="line">  <span class="keyword">int</span> currentWidth = getTargetWidth();</span><br><span class="line">  <span class="keyword">int</span> currentHeight = getTargetHeight();</span><br><span class="line">  <span class="keyword">if</span> (isViewStateAndSizeValid(currentWidth, currentHeight)) {</span><br><span class="line">    cb.onSizeReady(currentWidth, currentHeight);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We want to notify callbacks in the order they were added and we only expect one or two</span></span><br><span class="line">  <span class="comment">// callbacks to be added a time, so a List is a reasonable choice.</span></span><br><span class="line">  <span class="keyword">if</span> (!cbs.contains(cb)) {</span><br><span class="line">    cbs.add(cb);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (layoutListener == <span class="keyword">null</span>) {</span><br><span class="line">    ViewTreeObserver observer = view.getViewTreeObserver();</span><br><span class="line">    layoutListener = <span class="keyword">new</span> SizeDeterminerLayoutListener(<span class="keyword">this</span>);</span><br><span class="line">    observer.addOnPreDrawListener(layoutListener);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>所以通过三个步骤，最终会获得ViewTarget的宽高，并通过<code>SizeReadyCallback</code>对象的<code>onSizeReady</code>函数回调。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>{</span><br><span class="line">  stateVerifier.throwIfRecycled();</span><br><span class="line">  <span class="keyword">synchronized</span> (requestLock) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    status = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> sizeMultiplier = requestOptions.getSizeMultiplier();</span><br><span class="line">    <span class="keyword">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);</span><br><span class="line">    <span class="keyword">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);</span><br><span class="line"></span><br><span class="line">    loadStatus =</span><br><span class="line">        engine.load(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            requestOptions.getSignature(),</span><br><span class="line">            <span class="keyword">this</span>.width,</span><br><span class="line">            <span class="keyword">this</span>.height,</span><br><span class="line">            requestOptions.getResourceClass(),</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            requestOptions.getDiskCacheStrategy(),</span><br><span class="line">            requestOptions.getTransformations(),</span><br><span class="line">            requestOptions.isTransformationRequired(),</span><br><span class="line">            requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">            requestOptions.getOptions(),</span><br><span class="line">            requestOptions.isMemoryCacheable(),</span><br><span class="line">            requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">            requestOptions.getUseAnimationPool(),</span><br><span class="line">            requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            callbackExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != Status.RUNNING) {</span><br><span class="line">      loadStatus = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>所以<code>onSizeReady</code>最重要的点就是调用了<code>engine.load</code>开始本次<code>Glide</code>请求。</p>
<h3 id="engineload"><a class="markdownIt-Anchor" href="#engineload"></a> <code>engine.load</code></h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>{</span><br><span class="line">  <span class="keyword">long</span> startTime = VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  EngineKey key =</span><br><span class="line">      keyFactory.buildKey(</span><br><span class="line">          model,</span><br><span class="line">          signature,</span><br><span class="line">          width,</span><br><span class="line">          height,</span><br><span class="line">          transformations,</span><br><span class="line">          resourceClass,</span><br><span class="line">          transcodeClass,</span><br><span class="line">          options);</span><br><span class="line"></span><br><span class="line">  EngineResource&lt;?&gt; memoryResource;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">    <span class="comment">//步骤1</span></span><br><span class="line">    memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (memoryResource == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">//步骤2</span></span><br><span class="line">        <span class="keyword">return</span> waitForExistingOrStartNewJob(</span><br><span class="line">          glideContext,</span><br><span class="line">          model,</span><br><span class="line">          signature,</span><br><span class="line">          width,</span><br><span class="line">          height,</span><br><span class="line">          resourceClass,</span><br><span class="line">          transcodeClass,</span><br><span class="line">          priority,</span><br><span class="line">          diskCacheStrategy,</span><br><span class="line">          transformations,</span><br><span class="line">          isTransformationRequired,</span><br><span class="line">          isScaleOnlyOrNoTransform,</span><br><span class="line">          options,</span><br><span class="line">          isMemoryCacheable,</span><br><span class="line">          useUnlimitedSourceExecutorPool,</span><br><span class="line">          useAnimationPool,</span><br><span class="line">          onlyRetrieveFromCache,</span><br><span class="line">          cb,</span><br><span class="line">          callbackExecutor,</span><br><span class="line">          key,</span><br><span class="line">          startTime);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  cb.onResourceReady(</span><br><span class="line">      memoryResource, DataSource.MEMORY_CACHE, <span class="comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>步骤1</strong>：调用<code>loadFromMemory</code>函数从内存获取缓存，如果没有拿到缓存资源，则通过<strong>步骤2：</strong><code>waitForExistingOrStartNewJob</code>函数从磁盘缓存或者网络获取。下节再分享这里的Glide缓存。最后拿到资源，则通过<code>cb.onResourceReady</code>函数回调，回到<code>SingleRequest</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Resource&lt;?&gt; resource, DataSource dataSource, <span class="keyword">boolean</span> isLoadedFromAlternateCacheKey)</span> </span>{</span><br><span class="line">  stateVerifier.throwIfRecycled();</span><br><span class="line">  Resource&lt;?&gt; toRelease = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">synchronized</span> (requestLock) {</span><br><span class="line">  ......</span><br><span class="line">      onResourceReady(</span><br><span class="line">          (Resource&lt;R&gt;) resource, (R) received, dataSource, isLoadedFromAlternateCacheKey);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">finally</span> {</span><br><span class="line">    <span class="keyword">if</span> (toRelease != <span class="keyword">null</span>) {</span><br><span class="line">      engine.release(toRelease);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>onResourceReady</code>这里对一些合法性的检查，然后调用<code>onResourceReady</code>的重载函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Resource&lt;R&gt; resource, R result, DataSource dataSource, <span class="keyword">boolean</span> isAlternateCacheKey)</span> </span>{</span><br><span class="line">	...</span><br><span class="line">    target.onResourceReady(result, animation);</span><br><span class="line">	...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>重载的<code>onResourceReady</code>函数这里调用<code>target</code>的<code>onResourceReady</code>函数。这里定位到<code>ImageViewTarget</code>类。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(<span class="meta">@NonNull</span> Z resource, <span class="meta">@Nullable</span> Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) {</span><br><span class="line">    setResourceInternal(resource);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    maybeUpdateAnimatable(resource);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其实无论哪个分支，<code>maybeUpdateAnimatable</code>函数都会被执行，即判断当前资源是否可执行的动画。如果是的话，则直接开始执行。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateAnimatable</span><span class="params">(<span class="meta">@Nullable</span> Z resource)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Animatable) {</span><br><span class="line">    animatable = (Animatable) resource;</span><br><span class="line">    animatable.start();</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    animatable = <span class="keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>而<code>setResourceInternal</code>函数,先调用了<code>setResouce</code>函数，猜测该函数设置资源给<code>Target</code>。再调用<code>maybeUpdateAnimatable</code>函数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResourceInternal</span><span class="params">(<span class="meta">@Nullable</span> Z resource)</span> </span>{</span><br><span class="line">  setResource(resource);</span><br><span class="line">  maybeUpdateAnimatable(resource);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>setResource</code>在<code>ImageViewTarget</code>是一个抽象方法，看一下它的子类<code>BitmapImageViewTarget</code>的实现。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(Bitmap resource)</span> </span>{</span><br><span class="line">  view.setImageBitmap(resource);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>setResource</code>直接将<code>Bitmap</code>设置给了<code>ImageView</code>,那么图片也即将展示出来。</p>
<p>因为忽略了<code>engine.load</code>加载资源分析，所以<code>into</code>函数看起来很简单，但Glide的所有核心也正在这一部分，将通过后续文章分析该部分。</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>简简单单分析了Glide的流程三部曲，每一步是责任分明，创建单例与绑定生命周期，配置参数，开始请求。但这才刚刚开始，后续将更加枯燥无趣，黯然无色。</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a><a class="post-meta__tags" href="/tags/Glide/">Glide</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/04/02/Glide%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9D%A5%E6%BA%90/"><i class="fa fa-chevron-left">  </i><span>Glide 源码分析之数据</span></a></div><div class="next-post pull-right"><a href="/2021/03/18/Retrofit%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span>Retrofit 源码分析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By zhangws</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>